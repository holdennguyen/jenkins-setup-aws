<h1 align="center">
  <img alt="pipeline diagram" src="./docs/images/overview.png" width="100%"/><br/>
  Setup Jenkins v·ªõi AWS Autoscaling Group, Load Balancer v√† EFS
</h1>
<p align="center">Tri·ªÉn khai Jenkins v·ªõi AWS Autoscaling group c√πng Application Load Balancer v√† multi-AZ EFS.</p>

<p align="center"><a href="https://www.terraform.io/" target="_blank"><img src="https://img.shields.io/badge/-Terraform-7B42BC?logo=terraform&logoColor=white" alt="terraform" /></a>&nbsp;<a href="https://www.jenkins.io/" target="_blank"><img src="https://img.shields.io/badge/-Jenkins-D24939?logo=jenkins&logoColor=white" alt="jenkins" /></a>&nbsp;<a href="https://www.ansible.com/" target="_blank"><img src="https://img.shields.io/badge/-Ansible-EE0000?logo=ansible&logoColor=white" alt="ansible" /></a>&nbsp;<a href="https://www.docker.com/" target="_blank"><img src="https://img.shields.io/badge/-Docker-2496ED?logo=docker&logoColor=white" alt="Docker" /></a>&nbsp;<a href="https://aws.amazon.com/" target="_blank"><img src="https://img.shields.io/badge/-Amazon%20AWS-FF9900?logo=amazon-aws&logoColor=white" alt="AWS" /></a></p>

<p align="center">
    <b>LANGUAGE</b>
</p>
<p align="center">
    <a href="README.md"><img src="/docs/images/vi.png" width="25"></a>
    <a href="https://devopscube.com/jenkins-autoscaling-setup/"><img src="/docs/images/us.png" width="25"></a>
</p>

## üíù Ngu·ªìn tham kh·∫£o

GitHub: https://github.com/techiescamp/devops-projects <br>
Blog: https://devopscube.com/jenkins-autoscaling-setup/

## ‚ö°Ô∏è T·ªïng quan

Ch√∫ng ta s·∫Ω t·∫≠p trung v√†o m·ªôt s·ªë concept nh∆∞:
- [Immutable Infrastructure](https://devopscube.com/immutable-infrastructure/): M√¥ h√¨nh c∆° s·ªü h·∫° t·∫ßng kh√¥ng thay ƒë·ªïi sau khi ƒë∆∞·ª£c tri·ªÉn khai. C√°c th√†nh ph·∫ßn s·∫Ω ƒë∆∞·ª£c thay th·∫ø (replace) thay v√¨ thay ƒë·ªïi (change).
- [Infrastructure as Code](https://devopscube.com/infrastructure-as-code-configuration-management/) (Provisioning & Configuration Management): Thi·∫øt l·∫≠p, qu·∫£n l√Ω c∆° s·ªü h·∫° t·∫ßng h·ªá th·ªëng th√¥ng qua c√°c file script.
- External Config/Secret management: Qu·∫£n l√Ω th√¥ng tin b√≠ m·∫≠t.

#### C√°c tool DevOps ƒë∆∞·ª£c s·ª≠ d·ª•ng
- Packer: d√πng ƒë·ªÉ build [AMIs](https://devopscube.com/packer-tutorial-for-beginners/) cho Jenkins Controller v√† Agent.
- Ansible: ƒë√≥ng vai tr√≤ l√†m [provisioner cho Packer](https://developer.hashicorp.com/packer/plugins/provisioners/ansible/ansible) ƒë·ªÉ c·∫•u h√¨nh Jenkins controller v√† agent trong qu√° tr√¨nh build AMI.
- Terraform: d√πng ƒë·ªÉ t·∫°o c√°c AWS resource.
- Python Boto3: AWS SDK ƒë·ªÉ l·∫•y SSH public key t·ª´ AWS Parameter Store.

#### C√°c d·ªãch v·ª• AWS s·∫Ω s·ª≠ d·ª•ng
- IAM: t·∫°o IAM Role/Instance Profile cho Agent truy c·∫≠p v√†o AWS Parameter Store ƒë·ªÉ l·∫•y SSH public key.
- EFS: l∆∞u d·ªØ li·ªáu c·ªßa Jenkins Controller.
- AWS Parameter Store: l∆∞u private v√† public keys ƒë·ªÉ s·ª≠ d·ª•ng thi·∫øt l·∫≠p SSH gi·ªØa Jenkins Controller v√† Agent.
- Autoscaling Group: tri·ªÉn khai High Availability Jenkins Controller
- Application Load Balancer: cung c·∫•p DNS endpoint cho Jenkins Controller instance trong Autoscaling group.

## üìñ C·∫•u tr√∫c d·ª± √°n

```
jenkins-setup-aws/
‚îú‚îÄ‚îÄ ansible/
‚îÇ   ‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jenkins-agent/ tasks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ java.yaml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.yaml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ssh.yaml (../../../scripts/get-ssh-pub.py)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tools.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jenkins-controller/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ task/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ base.yaml
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ efs.yaml
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ jenkins.yaml (../templates/override.conf.j2)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ main.yaml
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ override.conf.j2
‚îÇ   ‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-ssh-pub.py
‚îÇ   ‚îú‚îÄ‚îÄ jenkins-agent.yaml
‚îÇ   ‚îú‚îÄ‚îÄ jenkins-controller.yaml
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ agent/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf (../modules/ec2/)
‚îÇ   ‚îú‚îÄ‚îÄ efs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf (../modules/efs/)
‚îÇ   ‚îú‚îÄ‚îÄ iam/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf (../modules/iam/)
‚îÇ   ‚îú‚îÄ‚îÄ lb-asg/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf (../modules/lb-asg/)
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ec2/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variable.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ efs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variable.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iam/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variable.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lb-asg/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variable.tf
‚îú‚îÄ‚îÄ jenkins-agent.pkr.hcl (ansible/jenkins-agent.yaml)
‚îú‚îÄ‚îÄ jenkins-controller.pkr.hcl (ansible/jenkins-controller.yaml)
```

- `jenkins-controller.pkr.hcl` v√† `jenkins-agent.pkr.hcl` l√† nh·ªØng Packer configuration file, khi d√πng Packer ch·∫°y s·∫Ω ƒë·ªìng th·ªùi run Ansible playbook trong th∆∞ m·ª•c `ansible/`
- Th∆∞ m·ª•c `ansible/` g·ªìm c√°c role m√† playbook s·∫Ω s·ª≠ d·ª•ng.
- M·ªói resource c·∫ßn t·∫°o s·∫Ω c√≥ c√°c file terraform ri√™ng bi·ªát ƒë·ªÉ ch·∫°y trong th∆∞ m·ª•c t∆∞∆°ng ·ª©ng, chi ti·∫øt c√°c resource n·∫±m trong c√°c file ·ªü th∆∞ m·ª•c `module/`.

## ‚öôÔ∏è Tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu
B·∫°n c·∫ßn c√†i ƒë·∫∑t v√† thi·∫øt l·∫≠p c√°c tool n√†y tr√™n m√°y t√≠nh, laptop s·ª≠ d·ª•ng cho vi·ªác tri·ªÉn khai d·ª± √°n: 
- [Hashicorp Packer](https://developer.hashicorp.com/packer/downloads)
- [Terraform](https://developer.hashicorp.com/terraform/downloads?product_intent=terraform)
- [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)
- [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html), thi·∫øt l·∫≠p AWS Credentials v·ªõi quy·ªÅn admin c·ªßa t√†i kho·∫£n AWS v√† ch·ªçn region (Repo n√†y m√¨nh ch·ªçn region Singapore: ap-southeast-1)

Ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng VPC m·∫∑c ƒë·ªãnh, 3 subnets m·∫∑c ƒë·ªãnh t∆∞∆°ng ·ª©ng v·ªõi 3 Availability Zone.

T·∫°o s·∫µ 1 keypairs tr√™n t√†i kho·∫£n AWS c·ªßa b·∫°n ·ªü region ƒë√£ thi·∫øt l·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng khi c·∫ßn d√πng giao th·ª©c SSH. (Keypairs c·ªßa m√¨nh s·ª≠ d·ª•ng trong repo n√†y t√™n l√† "jenkins-infr")

## ‚öôÔ∏è C√°c b∆∞·ªõc s·∫Ω th·ª±c hi·ªán
- T·∫°o SSH public v√† private keys l∆∞u v√†o AWS Parameter Store
- T·∫°o IAM Role ƒë·ªÉ Agent c√≥ quy·ªÅn l·∫•y SSH public key t·ª´ AWS Parameter Store
- T·∫°o Agent AMI
- D·ª±ng Agent
- T·∫°o EFS storage ƒë·ªÉ mount v√†o Jenkins Controller
- T·∫°o Jenkins Controller AMI
- D·ª±ng Jenkins Controller c√πng Autoscaling Group v√† Load Balancer
- Thi·∫øt l·∫≠p vai tr√≤ gi·ªØa Agent v√† Jenkins Controller

## T·∫°o SSH public v√† private keys l∆∞u v√†o AWS Parameter Store
Tr√™n m√°y t√≠nh c·ªßa b·∫°n, ch·∫°y l·ªánh sau ƒë·ªÉ t·∫°o m·ªôt c·∫∑p private (id_rsa) v√† public key (id_rsa.pub)

```
ssh-keygen
```

Truy c·∫≠p v√†o AWS Parameter Store, t·∫°o 2 parameters lo·∫°i "`Secure String`" v·ªõi `Name` t∆∞∆°ng ·ª©ng l√† 2 ƒë∆∞·ªùng d·∫´n sau:
```
/devops-tools/jenkins/id_rsa
/devops-tools/jenkins/id_rsa.pub
```

M√¥ ph·ªèng c√°ch t·∫°o parameter:
![parameter-store](/docs/parameter-store.gif)

## T·∫°o IAM Role ƒë·ªÉ Agent c√≥ quy·ªÅn l·∫•y SSH public key t·ª´ AWS Parameter Store

Trong qu√° tr√¨nh t·∫°o AMI c·ªßa Agent ·ªü nh·ªØng b∆∞·ªõc sau v·ªõi Packer, ch√∫ng ta s·∫Ω c·∫ßn IAM Role n√†y ƒë·ªÉ c·∫•p quy·ªÅn l·∫•y public key (id_rsa.pub) ƒë√£ l∆∞u v√†o Parameter Store.

V√†o th∆∞ m·ª•c `terraform/iam/`:
```
cd terraform/iam
```

Kh·ªüi t·∫°o d·ª± √°n terraform v√† ch·∫°y file c·∫•u h√¨nh v·ªõi c√°c l·ªánh:
```
terraform init
terraform plan
terraform apply --auto-approve
```

B∆∞·ªõc n√†y s·∫Ω t·∫°o IAM role c√≥ t√™n `jenkins-role`, b·∫°n c√≥ th·ªÉ truy c·∫≠p v√†o AWS console ƒë·ªÉ ki·ªÉm tra IAM Role n√†y c√πng v·ªõi policy ƒë√£ t·∫°o.

## T·∫°o AMI c·ªßa Agent

·ªû trong th∆∞ m·ª•c `ansible/roles/jenkins-agent/tasks`, ch√∫ng ta s·∫Ω t·∫°o c√°c task c√†i ƒë·∫∑t s·∫µ nh·ªØng tool nh∆∞ Terraform, Ansible, boto3, Java... 

ƒê·∫∑c bi·ªát ch√∫ √Ω task trong file `ssh.yaml` s·ª≠ d·ª•ng Python script trong th∆∞ m·ª•c `ansible/scripts/get-ssh-pub.py` ƒë·ªÉ l·∫•y public key ƒë√£ t·∫°o tr√™n AWS Parameter Store v√† th√™m v√†o SSH file `authorized_keys` tr√™n Agent.

Khi build AMI, Packer s·∫Ω t·∫°o EC2 instance theo nh∆∞ ch·ªâ ƒë·ªãnh v√† d√πng Ansible provisioner ƒë·ªÉ thi·∫øt l·∫≠p c√°c c√†i ƒë·∫∑t theo file playbook `jenkins-agent.yaml`. Qu√° tr√¨nh build AMI nh∆∞ sau:
![packer-workflow](/docs/images/packer-workflow.png)

Ti·∫øn h√†nh build AMI Agent b·∫±ng Packer v·ªõi c√¢u l·ªánh sau, truy·ªÅn v√†o bi·∫øn `public_key_path` s·ª≠ d·ª•ng trong file ansible play book `Name` c·ªßa parameter ƒë√£ t·∫°o cho public key tr√™n AWS Parameter Store.
```
packer build -var "public_key_path=/devops-tools/jenkins/id_rsa.pub" jenkins-agent.pkr.hcl
```

Sau khi Packer th·ª±c thi th√†nh c√¥ng, b·∫°n s·∫Ω th·∫•y `id` c·ªßa AMI Agent ƒë∆∞·ª£c in ra ·ªü output.

#### Gi·∫£i th√≠ch c√∫ ph√°p Packer HCL2 trong file *.pkr.hcl

[**Ansible Provisioner**](https://developer.hashicorp.com/packer/plugins/provisioners/ansible/ansible) 

`extra_arguments` ([]string) - ch·ªâ ƒë·ªãnh th√™m c√°c ƒë·ªëi s·ªë truy·ªÅn v√†o c√¢u l·ªánh Ansible (truy·ªÅn v√†o bi·∫øn, option...)

[**ansible arguments**](https://docs.ansible.com/ansible/latest/cli/ansible.html)

`--scp-extra-args -0` - s·ª≠ d·ª•ng OpenSSH "packet mode", hi·ªáu qu·∫£ h∆°n ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh khi chuy·ªÉn file qua c√°c k·∫øt n·ªëi ch·∫≠m, √≠t ·ªïn ƒë·ªãnh.
>k√Ω hi·ªáu single-quote `' '` ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ truy·ªÅn `-0` v√†o d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi s·ªë. N·∫øu kh√¥ng c√≥ `' '`, `-0` s·∫Ω b·ªã coi nh∆∞ m·ªôt option.
>```
>--scp-extra-args -0 
>--scp-extra-args '-0'
>```

`--ssh-extra-args -o IdentitiesOnly=yes -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa` - ·ªû phi√™n b·∫£n Openssh >= 8.8, thu·∫≠t to√°n ssh-rsa ƒë·∫∑c tr∆∞ng m·∫∑c ƒë·ªãnh b·ªã t·∫Øt. S·ª≠ d·ª•ng c√°c ƒë·ªëi s·ªë tr√™n cho `--ssh-extra-args` ƒë·ªÉ x·ª≠ l√Ω v·∫•n ƒë·ªÅ n√†y ·ªü ph√≠a Packer. Xem th√™m v·ªÅ issue n√†y [t·∫°i ƒë√¢y](https://github.com/hashicorp/packer-plugin-ansible/issues/140)

## D·ª±ng Agent.
ƒê·ªÉ t·∫°o Agent tr√™n AWS, v√†o th∆∞ m·ª•c `terraform/agent`
```
cd terraform/agent
```

M·ªü file `main.tf`, thay c√°c gi√° tr·ªã d∆∞·ªõi ƒë√¢y:
- `subnet_ids`: thay b·∫±ng `id` c·ªßa c√°c defaults subnet ·ªü region ƒë√£ ch·ªçn.
- `key_name`: thay b·∫±ng `name` c·ªßa AWS `keypairs` b·∫°n ƒë√£ t·∫°o t·ª´ tr∆∞·ªõc.
- `ami_id`: thay b·∫±ng `id` c·ªßa Agent AMI v·ª´a t·∫°o ·ªü b∆∞·ªõc tr∆∞·ªõc.
> N·∫øu b·∫°n mu·ªën d·ª± √°n c√≥ nhi·ªÅu h∆°n 1 instance, c√≥ th·ªÉ thay th·∫ø s·ªë l∆∞·ª£ng cho bi·∫øn `instance_count`

```
module "ec2_instance" {
  source = "../modules/ec2"

  instance_name      = "jenkins-agent"
  ami_id             = "ami-06ac8ae58c3362210"
  instance_type      = "t2.small"
  key_name           = "jenkins-infra"
  subnet_ids         = ["subnet-07b9057320054ee22", "subnet-0174fcc4415e4ca39", "subnet-0f1c1a6c2e947b004"]
  instance_count     = 1
}
```

Ch·∫°y c√°c l·ªánh sau ƒë·ªÉ ti·∫øn h√†nh t·∫°o resource AWS b·∫±ng Terraform:
```
terraform init
terraform plan
terraform apply --auto-approve
```

## T·∫°o EFS storage ƒë·ªÉ mount v√†o Jenkins Controller

Trong qu√° tr√¨nh t·∫°o AMI c·ªßa Jenkins Controller ·ªü nh·ªØng b∆∞·ªõc sau v·ªõi Packer, ch√∫ng ta s·∫Ω c·∫ßn mount EFS n√†y v√†o l√†m n∆°i l∆∞u tr·ªØ d·ªØ li·ªáu Jenkins. Nh·ªù ƒë√≥, khi Autoscaling group t·∫°o Jenkins Controller instance m·ªõi, m·ªçi d·ªØ li·ªáu c≈©ng nh∆∞ thi·∫øt l·∫≠p s·∫Ω ƒë·ªÅu kh√¥ng b·ªã m·∫•t ƒëi hay thay ƒë·ªïi.

V√†o th∆∞ m·ª•c `terraform/efs`:
```
cd terraform/efs
```

M·ªü file `main.tf` v√† thay th·∫ø th√¥ng tin `region`, `vpc_id` v√† `subnet_ids` th√†nh Default VPC, Subnet ID ·ªü region ƒë√£ ch·ªçn trong t√†i kho·∫£n AWS c·ªßa b·∫°n.
```
provider "aws" {
  region = "ap-southeast-1"
}

module "efs_module" {
  source     = "../modules/efs"
  vpc_id     = "vpc-0c64f388611289f06"
  subnet_ids = ["subnet-07b9057320054ee22", "subnet-0174fcc4415e4ca39", "subnet-0f1c1a6c2e947b004"]
}
```

Kh·ªüi t·∫°o d·ª± √°n terraform v√† ch·∫°y file c·∫•u h√¨nh v·ªõi c√°c l·ªánh:
```
terraform init
terraform plan
terraform apply --auto-approve
```

B·∫°n c√≥ th·ªÉ ki·ªÉm tra l·∫°i resource EFS ƒë√£ t·∫°o tr√™n AWS console
![efs](/docs/images/efs.png)

Ch√∫ng ta s·∫Ω d√πng `DNS name` c·ªßa EFS ƒë√£ t·∫°o trong b∆∞·ªõc t·∫°o AMI c·ªßa Jenkins controller.

## T·∫°o AMI c·ªßa Jenkins Controller

T∆∞∆°ng t·ª± c√°ch t·∫°o AMI c·ªßa Agent, ch√∫ng ta ch·∫°y file `jenkins-controller.pkr.hcl` v√† truy·ªÅn v√†o bi·∫øn `efs_mount_point` gi√° tr·ªã DNS name c·ªßa EFS ƒë√£ t·∫°o:
```
packer build -var "efs_mount_point=[G√≠a tr·ªã DNS name c·ªßa EFS ƒë√£ t·∫°o]" jenkins-controller.pkr.hcl
```

Sau khi Packer th·ª±c thi th√†nh c√¥ng, b·∫°n s·∫Ω th·∫•y `id` c·ªßa Jenkins Controller AMI ƒë√£ t·∫°o v√† ƒëƒÉng k√Ω tr√™n AWS ·ªü output.

## D·ª±ng Jenkins Controller c√πng Autoscaling Group v√† Load Balancer
ƒê·ªÉ tri·ªÉn khai Autoscaling group c√πng load balancer, v√†o th∆∞ m·ª•c `terraform/lb-asg`:
```
cd terraform/lb-asg
```

M·ªü file `main.tf` v√† thay th·∫ø c√°c gi√° tr·ªã c·ªßa nh·ªØng bi·∫øn sau:
- `subnets`: thay b·∫±ng `id` c·ªßa c√°c defaults subnet ·ªü region ƒë√£ ch·ªçn.
- `key_name`: thay b·∫±ng `name` c·ªßa AWS `keypairs` b·∫°n ƒë√£ t·∫°o t·ª´ tr∆∞·ªõc.
- `ami_id`: thay b·∫±ng `id` c·ªßa Jenkins Controller AMI v·ª´a t·∫°o ·ªü b∆∞·ªõc tr∆∞·ªõc.
- `vpc_id`: thay b·∫±ng `id` c·ªßa default vpc ·ªü region ƒë√£ ch·ªçn.

Kh·ªüi t·∫°o d·ª± √°n terraform v√† ch·∫°y file c·∫•u h√¨nh v·ªõi c√°c l·ªánh:
```
terraform init
terraform plan
terraform apply --auto-approve
```

Sau khi Terraform th·ª±c thi th√†nh c√¥ng, b·∫°n c√≥ th·ªÉ ki·ªÉm tra l·∫°i Autoscaling group v√† load balancer ƒë√£ t·∫°o tr√™n AWS console.

Ph√≠a d∆∞·ªõi ph·∫ßn Registered targets, b·∫°n s·∫Ω th·∫•y 1 Jenkins Controller instance ƒë√£ ƒë∆∞·ª£c t·∫°o:
![jenkins-controller](/docs/images/jenkins-controller.png)

M·ªü load balancer `jenkins-alb` ƒë√£ t·∫°o, b·∫°n s·∫Ω l·∫•y ƒë∆∞·ª£c DNS name c·ªßa load balancer ƒë·ªÉ truy c·∫≠p v√†o Jenkins Controller
![jenkins-alb](/docs/images/jenkins-alb.png)

·ªû l·∫ßn ƒë·∫ßu ti√™n truy c·∫≠p Jenkins Controller, b·∫°n s·∫Ω th·∫•y giao di·ªán nh∆∞ sau:
![jenkins-login](/docs/images/jenkins-login.png)

ƒê·ªÉ unlock Jenkins, l√†m theo h∆∞·ªõng d·∫´n SSH v√†o Jenkins Controller instance v·ªõi AWS `keypairs` ƒë√£ t·∫°o v√† ch·∫°y c√¢u l·ªánh:
```
sudo cat /data/jenkins/secrets/initialAdminPassword
```

B·∫°n c√≥ th·ªÉ v√†o AWS console l·∫•y ƒë·ªãa ch·ªâ IP public c·ªßa Jenkins Controller instance ho·∫∑c th√¥ng qua AWS CLI b·∫±ng c√°ch d√πng c√¢u l·ªánh sau:
```
aws ec2 describe-instances --filter "Name=tag:Name,Values=jenkins-controller" --query 'Reservations[].Instances[?State.Name==`running`].PublicIpAddress' --output text
```

Sau khi unlock Jenkins, l√†m theo h∆∞·ªõng d·∫´n ·ªü c√°c b∆∞·ªõc k·∫ø ti·∫øp v√† c√†i ƒë·∫∑t nh·ªØng plugin g·ª£i √Ω ƒë·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng Jenkins.

## Thi·∫øt l·∫≠p vai tr√≤ gi·ªØa Jenkins Controller v√† Agent
ƒê√¢y l√† b∆∞·ªõc l√†m th·ªß c√¥ng, ch·ªâ c·∫ßn th·ª±c hi·ªán m·ªôt l·∫ßn khi t·∫°o d·ª± √°n.
Remote v√†o **Agent** instance, t·∫°o user ri√™ng cho jenkins

#### T·∫°o SSH credential truy c·∫≠p v√†o Agent
Truy c·∫≠p v√†o **Jenkins Controller**, ·ªü giao di·ªán Dashboard ch·ªçn `Manage Jenkins` > `Manage Credentials`
![crediential1](/docs/images/credentials-1.png)

Ch·ªçn `Add Credentials` ·ªü ph·∫ßn dropdown c·ªßa global item:
![crediential2](/docs/images/credentials-2.png)

ƒêi·ªÅn c√°c th√¥ng tin c·∫ßn thi·∫øt:
- Kind: SSH Username with private key
- id: jenkins-agent
- username: jenkins (do trong qu√° tr√¨nh build AMI v·ªõi packer, n·∫øu b·∫°n ƒë·ªÉ √Ω trong file `jenkins-agent.pkr.hcl` v√† `ansible/roles/jenkins-agent/ssh.yaml` ch√∫ng ta ƒë√£ t·∫°o v√† s·ª≠ d·ª•ng user **jenkins** ƒë·ªÉ l∆∞u public key v√†o file `authorized_keys` tr√™n Agent)
- Private Key: truy c·∫≠p v√†o AWS Parameter Store, copy gi√° tr·ªã c·ªßa parameter t√™n `/devops-tools/jenkins/id_rsa` ƒë√£ t·∫°o ban ƒë·∫ßu.
![crediential3](/docs/images/credentials-3.png)

#### Thi·∫øt l·∫≠p Agent cho Jenkins Controller 
Tr√™n **Jenkins Controller**, ·ªü giao di·ªán Dashboard ch·ªçn `Manage Jenkins` > `Nodes and Clouds`
![node-1](/docs/images/node-1.png)
Ch·ªçn `New Node`, ƒë·∫∑t t√™n cho Agent (m√¨nh s·∫Ω ƒë·∫∑t l√† Agent1) v√† ch·ªçn lo·∫°i `Permanent Agent`
ƒêi·ªÅn c√°c th√¥ng tin c·∫ßn thi·∫øt:
- Remote root directory: /home/jenkins (th∆∞ m·ª•c tr√™n **Agent**)
- label: **agent1** (lable n√†y s·∫Ω s·ª≠ d·ª•ng ƒë·ªÉ khai b√°o trong job, pipeline)
- usage: only build jobs with lable expression
- Launch method:
  - Host: ƒë·ªãa ch·ªâ public IP c·ªßa Agent instance
  - Credential: ch·ªçn credential v·ª´a t·∫°o (id l√† jenkins-agent)
  - Host Key verfication Strategy: Non verifying verification strategy

B·∫•m `Save` ƒë·ªÉ ho√†n t·∫•t qu√° tr√¨nh thi·∫øt l·∫≠p.
![node-3](/docs/images/node-3.png)

·ªû log c·ªßa Node `Agent1`, d√≤ng cu·ªëi s·∫Ω th√¥ng b√°o **Agent successfully connected and online** n·∫øu b·∫°n thi·∫øt l·∫≠p th√†nh c√¥ng.

#### T·∫°o job ƒë·ªÉ ki·ªÉm tra
Tr√™n **Jenkins Controller**, ·ªü giao di·ªán Dashboard ch·ªçn `New Item`
- ƒê·∫∑t t√™n `Name`: Test Job
- Ch·ªçn `Freestyle project` v√† b·∫•m `OK`
- Ch·ªçn option `Restrict where this project can be run`
  - ·ªû ph·∫ßn Label Expression nh·∫≠p `agent1` (t√™n ƒë√£ ƒë·∫∑t cho Agent v·ª´a thi·∫øt l·∫≠p)
- Ch·ªçn `Execute shell` ·ªü ph·∫ßn **Build**
  - Th√™m l·ªánh: `echo $NODE_NAME` ·ªü ph·∫ßn `Command` c·ªßa `Execute shell` ƒë·ªÉ in ra log t√™n c·ªßa agent th·ª±c thi job ƒë√≥ khi ch·∫°y.
- B·∫•m `Save` v√† ch·ªçn `Build Now`. ƒê·ª£i v√†i gi√¢y v√† v√†o ph·∫ßn `Console Output`:
![node-7](/docs/images/node-7.png)
- B·∫°n s·∫Ω th·∫•y output t∆∞∆°ng t·ª± nh∆∞ sau:
```
Started by user Admin User
Running as SYSTEM
Building remotely on agent1 in workspace /home/jenkins/workspace/First Job to Agent1
[First Job to Agent1] $ /bin/sh -xe /tmp/jenkins15623311211559049312.sh
+ echo $NODE_NAME
agent1
Finished: SUCCESS
```

## D·ªçn d·∫πp AWS resource
ƒê·ªÉ tr√°nh ph√°t sinh chi ph√≠, h√£y nh·ªõ d·ªçn d·∫πp c√°c resource ƒë√£ t·∫°o cho d·ª± √°n n√†y khi kh√¥ng c·∫ßn ƒë·∫øn.

V√†o l·∫ßn l∆∞·ª£t c√°c th∆∞ m·ª•c trong `terraform/` v√† ch·∫°y l·ªánh:
```
terraform destroy
```

Truy c·∫≠p AWS Console, ch·ªçn service EC2 v√† Deregister c√°c AMI ƒë√£ t·∫°o, x√≥a c√°c file trong ph·∫ßn Snapshots (n·∫øu c√≥). T∆∞∆°ng t·ª± ti·∫øp t·ª•c x√≥a parameter ƒë√£ t·∫°o trong Parameter Store. 